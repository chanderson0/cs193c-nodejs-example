<!doctype html>
<html>
<head>
  <meta charset="utf-8">

  <title>SocketIO Example</title>
  <meta name="description" content="">
  <meta name="author" content="">

  <link rel="stylesheet" href="css/reset.css">
  <link href='http://fonts.googleapis.com/css?family=Gentium+Basic' rel='stylesheet' type='text/css'>
  <style>
    html, body { height: 100%; }

    body {
      text-align: center;
      background: #eee;
      font-family: 'Gentium Basic', georgia, serif;
    }

    div#content {
      position: absolute;
      top: 20px;
      left: 50%;

      width: 600px;
      margin-left: -300px;

      background: #fff;
      box-shadow: 2px 2px 4px #aaa;

      padding: 20px;
    }

    div#svg {
      height: 600px;
      width: 600px;
      background: #999;
    }

    h1 {
      font-size: 200%;
      margin-bottom: 10px;
    }

    p {
      margin: 15px 0;
    }
  </style>
</head>

<body>

<a href="https://github.com/chanderson0/cs193c-nodejs-example"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://a248.e.akamai.net/assets.github.com/img/71eeaab9d563c2b3c590319b398dd35683265e85/687474703a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67" alt="Fork me on GitHub"></a>

<div id="content">
  <h1>SocketIO Test</h1>
  <p>This is running on a socket.io server with <span id="how_many">0</span> connected users.</p>
  <div id="svg"></div>
</div>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="/js/raphael-min.js"></script>
<script>
  // Our SVG canvas.
  var paper = Raphael("svg", 600, 600);

  // Connect to the socket.io server.
  var socket = io.connect('/raphael');

  // Data. Nickname is our server-assigned identifier, objects keeps 
  // track of the RaphaelJS representations of room members with keys
  // that are their nicknames, and positions maintains the server's 
  // representation of their positions.
  var nickname = 0;
  var users = 0;
  var objects = {};
  var positions = {};

  // Functions for drag-and-drop.
  var start = function () {
    // storing original coordinates
    this.ox = this.attrs.x;
    this.oy = this.attrs.y;
  },
  move = function (dx, dy) {
    // Don't move if we're going off the screen.
    var nx = this.ox + dx;
    var ny = this.oy + dy;

    // Can't go off the screen;
    nx = Math.min(Math.max(nx, 0), paper.width - this.attrs.width);
    ny = Math.min(Math.max(ny, 0), paper.height - this.attrs.height);

    // move will be called with dx and dy
    this.attr({x: nx, y: ny});

    // Update our position representation, and notify the server. We floor
    // our position in order to minimize transport costs. In other words,
    // sending a bunch of decimal places isn't worth it.
    positions[nickname] = { 
      x: Math.floor(this.attrs.x), 
      y: Math.floor(this.attrs.y) 
    };
    socket.emit('move', positions[nickname]);
  },
  up = function() {
    // Nothing.
  };

  // This is a special event that gets fired only on first joining. We
  // get some initialization data from the server so we can get up and going.
  socket.on('me-join', function (data) {
    nickname = data.nickname;
    positions = data.positions;
    positions[nickname] = data.position;

    // We're the first user!
    users = 1;

    // Make an object for myself.
    objects[nickname] = paper.rect(positions[nickname].x, positions[nickname].y, 50, 50, 10)
      .attr({fill: '#990000'}); // Cardinal, of course.
    objects[nickname].drag(move, start, up);

    // Make an object for everyone.
    for (var n in positions) {
      if (n == nickname) continue;

      // One more user...
      ++users;

      data = positions[n];
      newguy = paper.rect(data.x, data.y, 50, 50)
        .attr({fill: '#232F5E'});
      objects[n] = newguy;
      newguy.toBack();
    }

    update_size();
  });

  // Someone joined this room, ignore if it's us.
  socket.on('join', function (data) {
    if (data.nickname == nickname) return;

    // Someone joined, make an object for them.
    newguy = paper.rect(data.position.x, data.position.y, 50, 50)
      .attr({fill: '#232F5E'});
    objects[data.nickname] = newguy;

    // Keep the newcomer in the background so we don't overlap.
    newguy.toBack();
    positions[data.nickname] = data.position;

    // We added a new friend.
    ++users;
    update_size();
  });

  // Someone moved - it could have been us, so we ignore this message
  // if it really was us that moved.
  socket.on('move', function (data) {
    if (data.nickname == nickname) return;

    // Someone moved, move them.
    objects[data.nickname].attr(data.position);
    positions[data.nickname] = data.position;
  });

  // Someone left, remove them.
  socket.on('leave', function(data) {
    objects[data.nickname].remove();
    delete positions[data.nickname];

    // We lost one!
    --users;
    update_size();
  });

  var update_size = function() {
    $('#how_many').html(users);
  }
</script>

</body>
</html>
