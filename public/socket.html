<div id="content"></div>

<script src="/socket.io/socket.io.js"></script>
<script src="/js/raphael-min.js"></script>
<script>
  // Our SVG canvas.
  var paper = Raphael("content", 600, 600);

  // Connect to the socket.io server.
  var socket = io.connect('/raphael');

  // Data. Nickname is our server-assigned identifier, objects keeps 
  // track of the RaphaelJS representations of room members with keys
  // that are their nicknames, and positions maintains the server's 
  // representation of their positions.
  var nickname = 0;
  var objects = {};
  var positions = {};

  // Functions for drag-and-drop.
  var start = function () {
    // storing original coordinates
    this.ox = this.attrs.x;
    this.oy = this.attrs.y;
  },
  move = function (dx, dy) {
    // move will be called with dx and dy
    this.attr({x: this.ox + dx, y: this.oy + dy});

    // Update our position representation, and notify the server. We floor
    // our position in order to minimize transport costs. In other words,
    // sending a bunch of decimal places isn't worth it.
    positions[nickname] = { 
      x: Math.floor(this.attrs.x), 
      y: Math.floor(this.attrs.y) 
    };
    socket.emit('move', positions[nickname]);
  },
  up = function() {
    // Nothing.
  };

  // This is a special event that gets fired only on first joining. We
  // get some initialization data from the server so we can get up and going.
  socket.on('me-join', function (data) {
    nickname = data.nickname;
    positions = data.positions;
    positions[nickname] = data.position;

    // Make an object for myself.
    objects[nickname] = paper.rect(positions[nickname].x, positions[nickname].y, 50, 50, 10)
      .attr({fill: '#555'});
    objects[nickname].drag(move, start, up);

    // Make an object for everyone.
    for (var n in positions) {
      if (n == nickname) continue;

      data = positions[n];
      newguy = paper.rect(data.x, data.y, 50, 50)
        .attr({fill: 'blue'});
      objects[n] = newguy;
      newguy.toBack();
    }
  });

  // Someone joined this room, ignore if it's us.
  socket.on('join', function (data) {
    if (data.nickname == nickname) return;

    // Someone joined, make an object for them.
    newguy = paper.rect(data.position.x, data.position.y, 50, 50).attr({fill: 'blue'});
    objects[data.nickname] = newguy;

    // Keep the newcomer in the background so we don't overlap.
    newguy.toBack();

    positions[data.nickname] = data.position;
  });

  // Someone moved - it could have been us, so we ignore this message
  // if it really was us that moved.
  socket.on('move', function (data) {
    if (data.nickname == nickname) return;

    // Someone moved, move them.
    objects[data.nickname].attr(data.position);
    positions[data.nickname] = data.position;
  });

  // Someone left, remove them.
  socket.on('leave', function(data) {
    objects[data.nickname].remove();
    delete positions[data.nickname];
  });
</script>