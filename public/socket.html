<div id="content"></div>

<script src="/socket.io/socket.io.js"></script>
<script src="/js/raphael-min.js"></script>
<script>
  // Our SVG canvas.
  var paper = Raphael("content", 600, 600);

  // Connect to the socket.io server.
  var socket = io.connect('/raphael');

  // Data...
  var nickname = 0;
  var objects = {};
  var positions = {};

  // Functions for drag-and-drop.
  var start = function () {
    // storing original coordinates
    this.ox = this.attrs.x;
    this.oy = this.attrs.y;
  },
  move = function (dx, dy) {
    // move will be called with dx and dy
    this.attr({x: this.ox + dx, y: this.oy + dy});

    // Update our position representation, and notify the server.
    positions[nickname] = { x: Math.floor(this.attrs.x), y: Math.floor(this.attrs.y) };
    socket.emit('move', positions[nickname]);
  },
  up = function() {
    // Nothing.
  };

  socket.on('me-join', function (data) {
    nickname = data.nickname;
    positions = data.positions;
    positions[nickname] = data.position;

    // Make an object for myself.
    objects[nickname] = paper.rect(positions[nickname].x, positions[nickname].y, 50, 50, 10)
      .attr({fill: '#555'});
    objects[nickname].drag(move, start, up);

    // Make an object for everyone.
    for (var n in positions) {
      if (n == nickname) continue;

      data = positions[n];
      newguy = paper.rect(data.x, data.y, 50, 50)
        .attr({fill: 'blue'});
      objects[n] = newguy;
      newguy.toBack();
    }
  });

  socket.on('join', function (data) {
    if (data.nickname == nickname) return;

    // Someone joined, make an object for them.
    newguy = paper.rect(data.position.x, data.position.y, 50, 50).attr({fill: 'blue'});
    objects[data.nickname] = newguy;

    // Keep the newcomer in the background so we don't overlap.
    newguy.toBack();

    positions[data.nickname] = data.position;
  });

  socket.on('move', function (data) {
    if (data.nickname == nickname) return;

    // Someone moved, move them.
    objects[data.nickname].attr(data.position);
    positions[data.nickname] = data.position;
  });

  socket.on('leave', function(data) {
    // Someone left, remove them.

    objects[data.nickname].remove();
    delete positions[data.nickname];
  });
</script>